import axios from "axios";

import { BASE_URL } from "./constants";
import { LangsList, NamespacesList, type Langs, type Translation } from "./types/estrutura";

//?????????????????????????????????????????????????????????????????????????????????
//? Variaveis exportadas
//?????????????????????????????????????????????????????????????????????????????????
let dicionario: Record<Langs, Translation>;

//?????????????????????????????????????????????????????????????????????????????????
//? Metodos exportados
//?????????????????????????????????????????????????????????????????????????????????
async function loadDicionario(): Promise<Record<Langs, Translation>> {
  dicionario = {} as Record<Langs, Translation>;

  const promises: Promise<void>[] = [];
  for (const lang of LangsList) {
    promises.push(loadLanguageNamespaces(lang));
  }
  await Promise.all(promises);

  return dicionario;
}

function formatTranslation(text: string, vars: Record<string, string | number>) {
  return text.replace(/{{(\w+)}}/g, (_, key) => (vars[key] !== undefined ? String(vars[key]) : `{${key}}`));
}

//?????????????????????????????????????????????????????????????????????????????????
//? Metodos internos
//?????????????????????????????????????????????????????????????????????????????????
async function loadLanguageNamespaces(lang: Langs): Promise<void> {
  const promises: Promise<void>[] = [];
  NamespacesList.forEach((namespace) => {
    promises.push(
      axios.get(`${BASE_URL}/${lang}/${namespace}`).then((response) => {
        // âœ… Atribui os dados ao dicionario
        dicionario[lang] = {
          ...dicionario[lang],
          [namespace]: response.data,
        };
      }),
    );
  });

  await Promise.all(promises);
}

// function loadLangFile(namespace: Namespace) {
//   let filePath: string;
//   filePath = path.join(process.cwd(), 'src', 'translations', 'jsons', `${namespace}.json`);
//   return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
// }

export { dicionario, loadDicionario, formatTranslation };
